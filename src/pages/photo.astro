---
import { getCldImageUrl } from "astro-cloudinary/helpers"
import Layout from "../layouts/Layout.astro";
import MakeupOptions from "../components/MakeupOptions.astro"

const { searchParams } = Astro.url

const id = searchParams.get("id")

if (id == null) return Astro.redirect("/")

const url = getCldImageUrl({ src: id })
---

<Layout title="Photo">
  <main data-id={id} class="py-4 px-4 mx-auto max-w-screen-xl text-center lg:py-16">
    <div class="flex flex-col items-center pb-10">
      <img class="w-52 h-52 mb-3 rounded-3xl shadow-lg" src={url} alt="image" />
      <h5 class="mb-1 text-xl font-medium text-slate-800">Choose an option</h5>
      <span class="text-sm text-slate-500">Do you want to look like a vampire or something truly terrifying?</span>
      <MakeupOptions />
      <input id="box"  class="hidden bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5 mt-7" type="text" placeholder="" />
      <button id="btn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center me-2 mb-2 mt-7">Generate</button>
    </div>
  </main>
</Layout>

<script>

  import { getCldImageUrl } from "astro-cloudinary/helpers"

  const id = document.querySelector("main")?.getAttribute("data-id") ?? ""
  const options = document.querySelector("#options") as HTMLSelectElement
  const box = document.querySelector("#box") as HTMLInputElement
  const btn = document.querySelector("#btn")

  let customOption: boolean = false

  // show or hidden input
  options.addEventListener("change", () => {

    customOption = options.value == "custom option"

    if (customOption) {
      box?.classList.remove("hidden")
    } else {
      box?.classList.add("hidden")
    }

  })

  btn?.addEventListener("click", (e) => {

    if (customOption && box.value !== "" || !customOption) {

      let prompt = customOption ? box.value : `a darkness ${options.value}`

      const url = getCldImageUrl({
        src: id,
        replaceBackground: prompt,
        grayscale: true,
        extract: 'face'
      })

      console.log(url)
    }

  })

</script>